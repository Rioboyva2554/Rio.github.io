"use strict";(self.webpackChunkafterlogic_aurora_platform=self.webpackChunkafterlogic_aurora_platform||[]).push([[999],{"1iYD":(e,s,t)=>{var i=t("M4cL");e.exports=function(e){var s=t("a7T2"),n=t("p09A"),a=t("H20a"),o=t("9kOp"),r="Notes",u=r;function l(e){var s=e().sNamespaceFolder,t=e().sDelimiter;u=""!==s?s+t+r:r;var i=e().getFolderByFullName(u);i&&(i.displayName=n.observable(a.i18n("MAILNOTESPLUGIN/LABEL_FOLDER_NOTES")),i.usedAs=n.observable(a.i18n("MAILNOTESPLUGIN/LABEL_USED_AS_NOTES")))}return o.isUserNormalOrTenant()?{start:function(e){i("html").addClass("MailNotesPlugin"),o.subscribeEvent("MailWebclient::ConstructView::before",(function(i){if("CMailView"===i.Name){var o=i.MailCache.folderList,r=n.computed((function(){return i.MailCache.folderList().currentFolder()})),c=new(t("n/wO"))(i.MailCache,s.bind(i.View.routeMessageView,i.View));l(o),o.subscribe((function(){l(o)})),r.subscribe((function(){var s=r()?r().fullName():"";s===u?(i.View.setCustomPreviewPane("MailNotesPlugin",c),i.View.setCustomBigButton("MailNotesPlugin",(function(){e.run("MailWebclient","setCustomRouting",[s,1,"","","","create-note"])}),a.i18n("MAILNOTESPLUGIN/ACTION_NEW_NOTE")),i.View.resetDisabledTools("MailNotesPlugin",["spam","move","mark"])):(i.View.removeCustomPreviewPane("MailNotesPlugin"),i.View.removeCustomBigButton("MailNotesPlugin"),i.View.resetDisabledTools("MailNotesPlugin",[]))}))}})),o.subscribeEvent("MailWebclient::ConstructView::after",(function(e){if("CMessageListView"===e.Name&&e.MailCache){var s=n.computed((function(){return e.MailCache.folderList().currentFolder()}));s.subscribe((function(){(s()?s().fullName():"")===u?e.View.customMessageItemViewTemplate("MailNotesPlugin_MessageItemView"):e.View.customMessageItemViewTemplate("")}))}})),o.subscribeEvent("MailWebclient::MessageDblClick::before",s.bind((function(e){e.Message&&e.Message.folder()===u&&(e.Cancel=!0)}),this))}}:null}},"n/wO":(e,s,t)=>{var i=t("a7T2"),n=t("M4cL"),a=t("p09A"),o=t("H20a"),r=t("EFhx"),u=t("/QeJ"),l=t("TdEd"),c=null;function g(e,s){c=e,this.fRouteMessageView=s,this.currentMessage=c.currentMessage,this.currentMessage.subscribe(this.onCurrentMessageSubscribe,this),this.messageText=a.observable(""),this.messageText.focused=a.observable(!1),a.computed((function(){this.messageText(),this.messageText.focused(!0)}),this).extend({throttle:5}),this.sMessageUid="",this.sMessageText="",this.isLoading=a.observable(!1),this.isSaving=a.observable(!1),this.createMode=a.observable(!1),this.saveButtonText=a.computed((function(){return this.isSaving()?o.i18n("COREWEBCLIENT/ACTION_SAVE_IN_PROGRESS"):o.i18n("COREWEBCLIENT/ACTION_SAVE")}),this),this.bBinded=!1}g.prototype.ViewTemplate="MailNotesPlugin_MessagePaneView",g.prototype.ViewConstructorName="CMessagePaneView",g.prototype.onShow=function(){this.bShown=!0},g.prototype.onHide=function(){this.bShown=!1},g.prototype.hasUnsavedChanges=function(){var e=this.currentMessage();return(!e||this.sMessageUid===e.uid())&&this.sMessageText!==this.messageText()},g.prototype.discardChanges=function(){this.currentMessage()||(this.sMessageUid="",this.sMessageText="",this.messageText(""))},g.prototype.getSubjectFromText=function(e){var s=e.split(/\r\n|\n/i),t=i.find(s,(function(e){return""!==n.trim(e)}));return(t=n.trim(t)).length>50&&(t=t.substring(0,50)),t},g.prototype.onCurrentMessageSubscribe=function(){var e,s=this.currentMessage();if(s){if(s.isPlain()?this.messageText(s.text()):this.messageText("string"!=typeof(e=s.text())?"":(e=e.replace(/\r\n/g," ").replace(/\n/g," ").replace(/<style[^>]*>[^<]*<\/style>/gi,"\n").replace(/<br *\/{0,1}>/gi,"\n").replace(/<\/p>/gi,"\n").replace(/(<\/div>)*$/,"").replace(/<(\/div>)+/gi,"\n").replace(/<a [^>]*href="([^"]*?)"[^>]*>(.*?)<\/a>/gi,(function(e,s,t){var i=s.replace(/(\w{3,4}:\/\/)(.*)/,"$2");return s===t||i===t?s:t+" ("+s+")"})).replace(/<[^>]*>/g,"").replace(/&nbsp;/g," ").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"'),n("<div>").html(e).text())),this.sMessageUid=s.uid(),this.sMessageText=this.messageText(),this.isLoading(""!==s.uid()&&!s.completelyFilled()),!s.completelyFilled())var t=s.completelyFilled.subscribe((function(){this.onCurrentMessageSubscribe(),t.dispose()}),this);this.isSaving(!1)}else this.sMessageUid="",this.sMessageText="",this.messageText("")},g.prototype.onBind=function(e){this.bBinded||(l.run("SessionTimeoutWeblient","registerFunction",[i.bind((function(){this.saveNote()}),this)]),n(document).on("keydown",n.proxy((function(e){e.ctrlKey&&e.keyCode===Enums.Key.s&&(e.preventDefault(),this.saveNote())}),this)),this.bBinded=!0)},g.prototype.onRoute=function(e,s){var t=c.getMessageActualIdentifiers(c.currentAccountId(),s.Folder,s.Uid);c.setCurrentMessage(t.iAccountId,t.sFolder,t.sUid),"create-note"===s.Custom?(this.messageText(""),this.createMode(!0)):this.createMode(!1),this.isSaving(!1)},g.prototype.saveNote=function(){this.createMode()?this.saveNewNote():this.saveEditedNote()},g.prototype.saveNewNote=function(){var e=c.getCurrentFolder(),s={AccountID:c.currentAccountId(),FolderFullName:e.fullName(),Text:o.encodeHtml(this.messageText()).replace(/\n/g,"<br />").replace(/\r\n/g,"<br />"),Subject:this.getSubjectFromText(this.messageText())};this.isSaving(!0),this.sMessageText=this.messageText(),r.send("MailNotesPlugin","SaveNote",s,(function(e){if(this.isSaving(!1),e.Result){if(this.bShown)var t=c.messagesLoading.subscribe((function(){!this.bShown||c.messagesLoading()||this.currentMessage()||(this.fRouteMessageView(s.FolderFullName,e.Result),t.dispose())}),this)}else u.showErrorByCode(e,o.i18n("MAILNOTESPLUGIN/ERROR_NOTE_SAVING"));c.executeCheckMail(!0)}),this)},g.prototype.saveEditedNote=function(e){if(e||(e=this.currentMessage()),e){var s={AccountID:c.currentAccountId(),FolderFullName:e.folder(),MessageUid:e.uid(),Text:o.encodeHtml(this.messageText()).replace(/\n/g,"<br />").replace(/\r\n/g,"<br />"),Subject:this.getSubjectFromText(this.messageText())};c.getFolderByFullName(c.currentAccountId(),e.folder()).markDeletedByUids([e.uid()]),c.excludeDeletedMessages(),this.isSaving(!0),this.sMessageText=this.messageText(),r.send("MailNotesPlugin","SaveNote",s,(function(e){if(this.isSaving(!1),e.Result){if(this.bShown)var t=c.messagesLoading.subscribe((function(){!this.bShown||c.messagesLoading()||this.currentMessage()||(this.fRouteMessageView(s.FolderFullName,e.Result),t.dispose())}),this)}else u.showErrorByCode(e,o.i18n("MAILNOTESPLUGIN/ERROR_NOTE_SAVING"));c.executeCheckMail(!0)}),this)}},g.prototype.cancel=function(){this.sMessageText=this.messageText(),l.run("MailWebclient","setCustomRouting",["Notes",1,"","","",""])},e.exports=g}}]);